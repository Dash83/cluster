<!DOCTYPE html>
<html>
  <head>
    <title>cluster</title>
    <link href="https://fonts.googleapis.com/css?family=M+PLUS+Rounded+1c" rel="stylesheet">
    <script type="text/javascript">
      var repo = '{{{url}}}';

      function get(url, callback) {
        var xhttp = new XMLHttpRequest();
        xhttp.open("GET", url);
        xhttp.send();
        xhttp.onreadystatechange = (e) => {
          try {
            var response = JSON.parse(xhttp.responseText);
            if (response.status == "ok") {
              delete response.status;
              callback(response);
            }
          } catch (e) {}
        }
      }

      function change() {
        var url = encodeURIComponent(document.getElementById('url').value).trim();
        if (url != "") {
          window.location = '/api/repo/' + url;
        }
      }

      function restart() {
        window.location = '/api/restart';
      }

      function update() {
        window.location = '/api/update';
      }

      function refreshStatus() {
        get("/api/status", (response) => {
          for (running of response.hosts) {
            var element = document.getElementById(running);
            if (typeof(element) != 'undefined' && element != null) {
              element.innerHTML = "running";
              element.classList.add('running');
            }
          }
        });
      }

      function checkRepo() {
        get("/api/repo", (response) => {
          if (response.url != repo) {
            update(); 
          }
        });
      }

      setInterval(refreshStatus, 500);
      setInterval(checkRepo, 500);
    </script>
    <style type="text/css">
      body {
        font-family: 'M PLUS Rounded 1c', sans-serif;
        padding: 15px;
      }

      a {
        color: #1da1f2; 
        text-decoration: none;
      }

      a.visited {
        color: #1da1f2; 
      }

      h1, h2, h3, p {
        margin: 0px; 
      }

      pre {
        padding: 10px;
        white-space: normal;
        background-color: #e9ebef;
        border-radius: 5px;
        counter-reset: line;
      }
      
      form {
        width: 100%; 
        display: flex;
        flex-direction: row;
      }

      button {
        -webkit-appearance: none;
        cursor: pointer; 
        font-family: 'M PLUS Rounded 1c', sans-serif;
        font-size: 1em;
        background-color: white;
        border: 1px #1da1f2 solid;
        color: #1da1f2;
        border-radius: 5px;
        transition: background-color 100ms, color 100ms;
        padding: 3px 5px 3px 5px;
      }

      button:hover {
        background-color: #1da1f2;
        color: white;
      }

      input[type="text"] {
        -webkit-appearance: none;
        font-family: 'M PLUS Rounded 1c', sans-serif;
        font-size: 1em; 
        border-radius: 5px;
        border: 1px #ddd solid;
        padding: 3px 5px 3px 5px;
        box-shadow: none;
        width: 100%;
        margin-right: 20px;
      }

      .status {
        color: #d84231; 
      }

      .status.running {
        color: #78c42d; 
      }

      .split {
        display: flex;
        flex-direction: row;
        width: 100%;
        height: 100%;
      }

      .split div {
        margin: 10px; 
        width: 100%;
      }

      #update {
        float: right; 
      }
    </style>
  </head>
  <body>
    <h1>cluster</h1>
    <h3>v0.1.0</h3>
    <br><br>
    <p id="info">
      cloned repository
      <a href="{{url}}">{{url}}</a>
      <button id="update" onclick="update()">update</button>
    </p>
    <br>
    <form>
      <input id="url" type="text" placeholder="https://github.com/doctorn/cluster_example.git"/>
      <button onclick="change()">change</button>
    </form>
    <br>
    <button onclick="restart()">restart</button>
    <br>
    <h2>{{name}}</h2>
    <div class="split">
      {{#if command}}
        <div>
          <h3>global setup</h3>
          <pre>
            {{command}}
            {{#each args as |arg|}}
              {{arg}}
            {{/each}}
          </pre>
        </div>
      {{/if}}
      <div>
      <div>
        <h3>hosts</h3>
        {{#each hosts}}
          <p>{{@key}}
            (<span class="status {{#if running}}running{{/if}}" id="{{@key}}">{{#if running}}running{{else}}not running{{/if}}</span>)
          </p>
          {{#if command}}
            <pre>
              {{command}}
              {{#each args as |arg|}}
                {{arg}}
              {{/each}}
            </pre>
          {{/if}}
        {{/each}}
      </div>
    </div>
  </body>
</html>
